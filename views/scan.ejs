<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Batsun — Deep security scan</title>
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1"
    />
  </head>
  <body
    style="
      height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #050616 0%, #071427 60%);
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto,
        Helvetica, Arial;
      color: #e6f5ff;
      -webkit-font-smoothing: antialiased;
    "
  >
    <main
      role="main"
      aria-live="polite"
      style="
        width: min(94vw, 640px);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(2, 6, 23, 0.7),
          inset 0 1px 0 rgba(255, 255, 255, 0.02);
        background: linear-gradient(
          180deg,
          rgba(11, 20, 34, 0.95),
          rgba(8, 14, 24, 0.92)
        );
        border: 1px solid rgba(255, 255, 255, 0.03);
        margin: 16px;
      "
    >
      <!-- header -->
      <header
        style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap"
      >
        <div
          aria-hidden="true"
          style="
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, #083241, #04262f);
            box-shadow: 0 8px 22px rgba(3, 18, 27, 0.6);
            flex: 0 0 60px;
          "
        >
          <svg
            width="38"
            height="38"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            style="filter: drop-shadow(0 6px 12px rgba(6, 182, 212, 0.12))"
          >
            <path
              d="M12 1l7 3.5v5C19 15.5 16.4 19.4 12 21 7.6 19.4 5 15.5 5 9.5v-5L12 1z"
              fill="#06b6d4"
            />
            <path
              d="M10.6 12.3c.3.3.8.3 1.1 0l2.9-2.9a.8.8 0 0 0 0-1.1.8.8 0 0 0-1.1 0L11.2 10.8l-1.1-1.1a.8.8 0 0 0-1.1 0 .8.8 0 0 0 0 1.1l1.6 1.5z"
              fill="#07202a"
            />
          </svg>
        </div>

        <div style="flex: 1; min-width: 0">
          <div
            style="
              display: flex;
              align-items: center;
              gap: 8px;
              flex-wrap: wrap;
            "
          >
            <h1
              style="
                margin: 0;
                font-size: 18px;
                line-height: 1.05;
                color: #dff9ff;
              "
            >
              Deep security scan in progress
            </h1>
            <span
              style="
                font-size: 11px;
                color: #9fb6c2;
                padding: 4px 8px;
                border-radius: 999px;
                background: rgba(255, 255, 255, 0.02);
                margin-left: auto;
              "
              >Batsun</span
            >
          </div>
          <p style="margin: 6px 0 0; color: #97b6c4; font-size: 13px">
            Scanning file for malware, obfuscation, and suspicious behavior.
            Estimated time: a few seconds.
          </p>
        </div>

        <div
          style="
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
          "
        >
          <div style="font-size: 11px; color: #9fb6c2">Status</div>
          <div
            id="miniPercent"
            style="font-weight: 700; color: #e8fbff; font-size: 15px"
          >
            0%
          </div>
        </div>
      </header>

      <!-- progress + details -->
      <section aria-hidden="false" style="margin-top: 16px">
        <div
          style="
            background: linear-gradient(
              180deg,
              rgba(255, 255, 255, 0.01),
              rgba(255, 255, 255, 0.005)
            );
            border-radius: 10px;
            padding: 14px;
            border: 1px solid rgba(255, 255, 255, 0.02);
            box-shadow: 0 8px 30px rgba(2, 8, 18, 0.6);
          "
        >
          <div
            style="
              display: flex;
              align-items: center;
              gap: 12px;
              flex-wrap: wrap;
            "
          >
            <div style="flex: 1; min-width: 0">
              <div
                style="
                  height: 14px;
                  background: rgba(255, 255, 255, 0.04);
                  border-radius: 12px;
                  overflow: hidden;
                  position: relative;
                "
              >
                <div
                  id="progressBar"
                  role="progressbar"
                  aria-valuemin="0"
                  aria-valuemax="100"
                  aria-valuenow="0"
                  style="
                    width: 0%;
                    height: 100%;
                    background: linear-gradient(
                      90deg,
                      #06b6d4 0%,
                      #06a6ff 50%,
                      #5fe7ff 100%
                    );
                    box-shadow: 0 8px 24px rgba(6, 182, 212, 0.12);
                    transition: width 160ms linear;
                    position: relative;
                  "
                >
                  <div
                    style="
                      position: absolute;
                      right: -40%;
                      top: 0;
                      bottom: 0;
                      width: 40%;
                      background: linear-gradient(
                        90deg,
                        rgba(255, 255, 255, 0.08),
                        rgba(255, 255, 255, 0.02)
                      );
                      transform: skewX(-18deg);
                      opacity: 0.95;
                    "
                  ></div>
                </div>
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  margin-top: 8px;
                  font-size: 13px;
                  color: #9fb6c2;
                "
              >
                <div id="statusLeft">Checking signatures</div>
                <div id="percent">0%</div>
              </div>
            </div>

            <div
              style="
                width: 48px;
                height: 48px;
                border-radius: 10px;
                background: linear-gradient(180deg, #041a21, #05262c);
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02);
                flex: 0 0 48px;
              "
            >
              <svg
                width="26"
                height="26"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                id="spinner"
              >
                <circle
                  cx="12"
                  cy="12"
                  r="9"
                  stroke="#07333a"
                  stroke-width="3"
                ></circle>
                <path
                  d="M21 12a9 9 0 0 1-9 9"
                  stroke="#06b6d4"
                  stroke-width="3"
                  stroke-linecap="round"
                ></path>
              </svg>
            </div>
          </div>

          <div
            style="
              display: flex;
              gap: 8px;
              margin: 12px 0 0;
              padding: 0;
              list-style: none;
              flex-wrap: wrap;
            "
          >
            <div
              style="
                flex: 1;
                min-width: 110px;
                padding: 8px;
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.01);
                font-size: 12px;
                color: #9fb6c2;
                text-align: center;
              "
            >
              Signature DB
            </div>
            <div
              style="
                flex: 1;
                min-width: 110px;
                padding: 8px;
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.01);
                font-size: 12px;
                color: #9fb6c2;
                text-align: center;
              "
            >
              Heuristic
            </div>
            <div
              style="
                flex: 1;
                min-width: 110px;
                padding: 8px;
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.01);
                font-size: 12px;
                color: #9fb6c2;
                text-align: center;
              "
            >
              Sandbox
            </div>
            <div
              style="
                flex: 1;
                min-width: 110px;
                padding: 8px;
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.01);
                font-size: 12px;
                color: #9fb6c2;
                text-align: center;
              "
            >
              Final
            </div>
          </div>

          <div
            style="
              margin-top: 12px;
              font-size: 12px;
              color: #8faeb8;
              text-align: center;
            "
          >
            File will be downloaded automatically once scanning completes.
          </div>
        </div>
      </section>

      <footer
        style="
          margin-top: 14px;
          display: flex;
          flex-wrap: wrap;
          justify-content: space-between;
          align-items: center;
          font-size: 12px;
          color: #7f9da9;
          gap: 8px;
        "
      >
        <div>Secured by <strong style="color: #bff7ff">Batsun</strong></div>
        <div>ETA: <span id="eta">~3s</span></div>
      </footer>
    </main>

    <script nonce="<%= nonce %>">
      (() => {
        const bar = document.getElementById("progressBar");
        const percentEl = document.getElementById("percent");
        const mini = document.getElementById("miniPercent");
        const statusLeft = document.getElementById("statusLeft");
        const etaEl = document.getElementById("eta");
        const spinner = document.getElementById("spinner");

        const stages = [
          { pct: 8, text: "Loading signature DB" },
          { pct: 28, text: "Analyzing common heuristics" },
          { pct: 52, text: "Emulating in sandbox" },
          { pct: 76, text: "Detecting obfuscation patterns" },
          { pct: 92, text: "Verifying threats" },
          { pct: 100, text: "Scan complete — preparing download" },
        ];

        const duration = 3400;
        const start = Date.now();

        let spinAngle = 0;
        const spin = () => {
          spinAngle = (spinAngle + 6) % 360;
          if (spinner) spinner.style.transform = "rotate(" + spinAngle + "deg)";
          requestAnimationFrame(spin);
        };
        requestAnimationFrame(spin);

        const updateFrame = () => {
          const elapsed = Date.now() - start;
          const t = Math.min(1, elapsed / duration);
          const eased = 1 - Math.pow(1 - t, 2);
          const cur = Math.floor(eased * 100);

          if (bar) bar.style.width = cur + "%";
          if (percentEl) percentEl.textContent = cur + "%";
          if (mini) mini.textContent = cur + "%";

          for (let i = 0; i < stages.length; i++) {
            if (cur >= stages[i].pct) statusLeft.textContent = stages[i].text;
          }

          const remaining = Math.max(0, duration - elapsed);
          if (etaEl) etaEl.textContent = Math.ceil(remaining / 1000) + "s";

          if (cur < 100) requestAnimationFrame(updateFrame);
          else setTimeout(() => triggerDownload(), 500);
        };

        const triggerDownload = () => {
          try {
            const b64 = "<%= base64File %>";
            const binaryString = atob(b64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
            const blob = new Blob([bytes], { type: "application/pdf" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "<%= filename %>";
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
              URL.revokeObjectURL(a.href);
              a.remove();
              document.querySelector("main").innerHTML = `
            <div style="text-align:center;padding:30px;">
              <svg width="60" height="60" viewBox="0 0 24 24" fill="none" style="margin-bottom:20px;">
                <path d="M12 1l7 3.5v5C19 15.5 16.4 19.4 12 21 7.6 19.4 5 15.5 5 9.5v-5L12 1z" fill="#06b6d4"/>
                <path d="M10.6 12.3c.3.3.8.3 1.1 0l2.9-2.9a.8.8 0 0 0 0-1.1.8.8 0 0 0-1.1 0L11.2 10.8l-1.1-1.1a.8.8 0 0 0-1.1 0 .8.8 0 0 0 0 1.1l1.6 1.5z" fill="#07202a"/>
              </svg>
              <h2 style="margin:10px 0;color:#dff9ff;font-size:22px;">File ready to be downloaded</h2>
              <p style="margin:8px 0 0;color:#9fb6c2;font-size:14px;">Download will start automatically.</p>
              <p style="margin-top:18px;font-size:12px;color:#7f9da9;">Secured by <strong style="color:#bff7ff;">Batsun</strong></p>
            </div>
          `;
            }, 900);
          } catch (err) {
            document.body.innerHTML =
              '<div style="padding:20px;color:#fff;background:#0b1220;font-family:Inter,system-ui;">Download failed — try again.</div>';
          }
        };

        requestAnimationFrame(updateFrame);
      })();
    </script>
  </body>
</html>
